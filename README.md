# Instantly API v2 Integration

Una aplicaci√≥n backend completa desarrollada en Node.js que se integra con Firebase Cloud Functions para conectarse con la API v2 de Instantly y extraer informaci√≥n de campa√±as de email marketing.

## üöÄ Caracter√≠sticas Principales

- **Integraci√≥n completa con Instantly API v2**
- **Sincronizaci√≥n autom√°tica de campa√±as**
- **Almacenamiento optimizado en Firestore**
- **Cloud Functions HTTP, Callable y Programadas**
- **Manejo avanzado de rate limiting y reintentos**
- **Gesti√≥n autom√°tica de tokens y autenticaci√≥n**
- **Sistema de logging estructurado**
- **Tests automatizados**
- **Monitoreo y estad√≠sticas en tiempo real**

## üõ†Ô∏è Stack Tecnol√≥gico

- **Runtime**: Node.js 18+
- **Lenguaje**: JavaScript (ES6+)
- **Base de Datos**: Google Firestore
- **Servicios**: Google Cloud Functions v2
- **API Externa**: Instantly API v2
- **Dependencias**: Firebase Admin SDK, Axios, Express, CORS

## üìÅ Estructura del Proyecto

```
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ firebase.js          # Configuraci√≥n de Firebase Admin
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ instantly.js         # Configuraci√≥n de Instantly API
‚îÇ   ‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js             # Cloud Functions principales
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scheduler-config.js  # Configuraci√≥n de funciones programadas
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Campaign.js          # Modelo de datos para campa√±as
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ InstantlyService.js  # Servicio principal de la API
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ logger.js             # Utilidad de logging
‚îÇ       ‚îú‚îÄ‚îÄ rateLimiter.js       # Sistema de rate limiting
‚îÇ       ‚îî‚îÄ‚îÄ tokenManager.js      # Gesti√≥n de tokens
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ Campaign.test.js         # Tests del modelo Campaign
‚îú‚îÄ‚îÄ firebase.json                 # Configuraci√≥n de Firebase
‚îú‚îÄ‚îÄ firestore.rules              # Reglas de seguridad de Firestore
‚îú‚îÄ‚îÄ firestore.indexes.json       # √çndices de Firestore
‚îú‚îÄ‚îÄ package.json                 # Dependencias y scripts
‚îú‚îÄ‚îÄ env.example                  # Variables de entorno de ejemplo
‚îú‚îÄ‚îÄ API_DOCUMENTATION.md         # Documentaci√≥n completa de la API
‚îî‚îÄ‚îÄ README.md                    # Este archivo
```

## üöÄ Instalaci√≥n y Configuraci√≥n

### 1. Clonar el repositorio

```bash
git clone <repository-url>
cd instantly-api-integration
```

### 2. Instalar dependencias

```bash
npm install
```

### 3. Configurar variables de entorno

```bash
cp env.example .env
```

Editar el archivo `.env` con tus credenciales:

```env
# ============================================================================
# INSTANTLY API CONFIGURATION
# ============================================================================
INSTANTLY_API_KEY=tu_api_key_de_instantly
INSTANTLY_API_BASE_URL=https://api.instantly.ai/api/v2

# ============================================================================
# FIREBASE CONFIGURATION
# ============================================================================
FIREBASE_PROJECT_ID=tu_project_id
FIREBASE_PRIVATE_KEY_ID=tu_private_key_id
FIREBASE_PRIVATE_KEY=tu_private_key
FIREBASE_CLIENT_EMAIL=tu_client_email
FIREBASE_CLIENT_ID=tu_client_id
FIREBASE_AUTH_URI=https://accounts.google.com/o/oauth2/auth
FIREBASE_TOKEN_URI=https://oauth2.googleapis.com/token
FIREBASE_AUTH_PROVIDER_X509_CERT_URL=https://www.googleapis.com/oauth2/v1/certs
FIREBASE_CLIENT_X509_CERT_URL=tu_cert_url

# ============================================================================
# APPLICATION CONFIGURATION
# ============================================================================
NODE_ENV=development
PORT=5001

# ============================================================================
# SYNC & RATE LIMITING CONFIGURATION
# ============================================================================
SYNC_INTERVAL_MINUTES=30
MAX_RETRY_ATTEMPTS=3
RATE_LIMIT_DELAY_MS=1000

# ============================================================================
# SCHEDULED FUNCTIONS CONFIGURATION
# ============================================================================
DAILY_SYNC_SCHEDULE="0 2 * * *"
WEEKLY_CLEANUP_SCHEDULE="0 3 * * 0"
TIMEZONE=America/Mexico_City

# ============================================================================
# FUNCTION PERFORMANCE CONFIGURATION
# ============================================================================
MAX_INSTANCES=10
TIMEOUT_SECONDS=540
MEMORY_MB=256
```

### 4. Configurar Firebase

```bash
# Instalar Firebase CLI globalmente
npm install -g firebase-tools

# Iniciar sesi√≥n en Firebase
firebase login

# Inicializar el proyecto
firebase init

# Seleccionar:
# - Functions
# - Firestore
# - Use existing project
```

### 5. Desplegar

```bash
# Construir el proyecto
npm run build

# Desplegar a Firebase
npm run deploy

# Ejecutar localmente
npm start
```

## üîß Uso

### Endpoints Disponibles

#### üîÑ Sincronizaci√≥n de Campa√±as

- **`POST /syncAllCampaigns`** - Sincronizar todas las campa√±as
- **`POST /syncCampaignById`** - Sincronizar campa√±a espec√≠fica
- **`POST /syncCampaignsCallable`** - Sincronizaci√≥n con autenticaci√≥n (Callable)

#### üìä Consulta de Datos

- **`GET /getCampaigns`** - Obtener todas las campa√±as con paginaci√≥n
- **`GET /getCampaigns?status=active&limit=50&page=1`** - Filtrar y paginar
- **`GET /getCampaignById/{campaignId}`** - Obtener campa√±a espec√≠fica
- **`GET /getCampaignMetrics/{campaignId}`** - Obtener m√©tricas en tiempo real

#### üõ†Ô∏è Mantenimiento y Monitoreo

- **`GET /testConnection`** - Probar conexi√≥n con Instantly API
- **`GET /getSyncStats`** - Estad√≠sticas de sincronizaci√≥n
- **`GET /hello`** - Funci√≥n de prueba y lista de endpoints

### Funciones Programadas (Autom√°ticas)

#### üìÖ Sincronizaci√≥n Diaria

- **Horario**: Todos los d√≠as a las 2:00 AM (Mexico City)
- **Funci√≥n**: `scheduledCampaignSync`
- **Descripci√≥n**: Sincroniza autom√°ticamente todas las campa√±as

#### üßπ Limpieza Semanal

- **Horario**: Todos los domingos a las 3:00 AM (Mexico City)
- **Funci√≥n**: `cleanupOldData`
- **Descripci√≥n**: Limpia datos antiguos y optimiza la base de datos

### Ejemplos de Uso

#### Sincronizaci√≥n Manual

```bash
# Sincronizar todas las campa√±as
curl -X POST https://your-project.cloudfunctions.net/syncAllCampaigns

# Sincronizar campa√±a espec√≠fica
curl -X POST https://your-project.cloudfunctions.net/syncCampaignById \
  -H "Content-Type: application/json" \
  -d '{"campaignId": "campaign_123"}'
```

#### Consulta de Datos

```bash
# Obtener campa√±as activas
curl "https://your-project.cloudfunctions.net/getCampaigns?status=active&limit=20"

# Obtener campa√±a espec√≠fica
curl https://your-project.cloudfunctions.net/getCampaignById/campaign_123

# Obtener m√©tricas en tiempo real
curl https://your-project.cloudfunctions.net/getCampaignMetrics/campaign_123
```

#### Monitoreo

```bash
# Probar conexi√≥n
curl https://your-project.cloudfunctions.net/testConnection

# Probar endpoint de campa√±as espec√≠ficamente
curl https://your-project.cloudfunctions.net/testCampaignsEndpoint

# Debug de respuesta de API
curl -X POST https://your-project.cloudfunctions.net/debugApiResponse \
  -H "Content-Type: application/json" \
  -d '{"endpoint": "/campaigns", "params": {"page": 1, "limit": 5}}'

# Obtener estad√≠sticas
curl https://your-project.cloudfunctions.net/getSyncStats
```

## üìä Estructura de Datos

### Colecci√≥n: campaigns

```javascript
{
  id: "string",                    // ID √∫nico de la campa√±a
  name: "string",                  // Nombre de la campa√±a
  status: "string",                // Estado (active, paused, completed, draft)
  createdAt: "timestamp",          // Fecha de creaci√≥n
  updatedAt: "timestamp",          // √öltima modificaci√≥n
  scheduledAt: "timestamp",        // Fecha programada
  completedAt: "timestamp",        // Fecha de finalizaci√≥n
  subject: "string",               // Asunto del email
  fromEmail: "string",             // Email remitente
  fromName: "string",              // Nombre remitente
  replyTo: "string",               // Email de respuesta
  templateId: "string",            // ID de la plantilla
  listId: "string",                // ID de la lista
  metrics: {                       // M√©tricas de rendimiento
    sent: "number",
    delivered: "number",
    opened: "number",
    clicked: "number",
    bounced: "number",
    unsubscribed: "number"
  },
  settings: "object",              // Configuraci√≥n adicional
  tags: ["array"],                 // Etiquetas
  lastSyncedAt: "timestamp"        // √öltima sincronizaci√≥n
}
```

### Colecci√≥n: system (para tokens y configuraci√≥n)

```javascript
{
  id: "instantly_tokens",
  token: "string",                 // Token actual
  expiry: "timestamp",            // Fecha de expiraci√≥n
  lastUpdated: "timestamp",        // √öltima actualizaci√≥n
  apiKeyHash: "string"            // Hash del API key para verificaci√≥n
}
```

## üöÄ Caracter√≠sticas Avanzadas

### Rate Limiting Inteligente

- **Control autom√°tico**: Respeta l√≠mites de 60 requests/minuto
- **Backoff exponencial**: Reintentos inteligentes con delays crecientes
- **Procesamiento por lotes**: Manejo eficiente de m√∫ltiples requests
- **Configuraci√≥n flexible**: Diferentes l√≠mites por tipo de operaci√≥n

### Gesti√≥n de Tokens

- **Renovaci√≥n autom√°tica**: Tokens se renuevan antes de expirar
- **Almacenamiento seguro**: Tokens se guardan en Firestore
- **Validaci√≥n continua**: Verificaci√≥n autom√°tica de validez
- **Fallback robusto**: M√∫ltiples estrategias de autenticaci√≥n

### Logging Estructurado

- **Contexto completo**: Cada log incluye informaci√≥n de la operaci√≥n
- **Niveles de log**: Info, Warning, Error con filtrado
- **M√©tricas integradas**: Conteo de operaciones y rendimiento
- **Debugging avanzado**: Stack traces y contexto de errores

## üß™ Testing

```bash
# Ejecutar todos los tests
npm test

# Ejecutar tests en modo watch
npm run test:watch

# Ejecutar tests con coverage
npm test -- --coverage

# Ejecutar tests espec√≠ficos
npm test -- Campaign.test.js
```

## üîß Troubleshooting

### Error: "campaigns is not iterable"

Este error indica que la respuesta de la API de Instantly no tiene la estructura esperada. Para debuggear:

```bash
# 1. Probar conexi√≥n b√°sica
curl https://your-project.cloudfunctions.net/testConnection

# 2. Probar endpoint de campa√±as espec√≠ficamente
curl https://your-project.cloudfunctions.net/testCampaignsEndpoint

# 3. Debug de respuesta de API
curl -X POST https://your-project.cloudfunctions.net/debugApiResponse \
  -H "Content-Type: application/json" \
  -d '{"endpoint": "/campaigns", "params": {"page": 1, "limit": 5}}'

# 4. Usar script de debug local
node debug-instantly.js
```

### Scripts de Debug

- **`debug-instantly.js`**: Script local para probar la API de Instantly
- **`test-api.js`**: Script simple para validar respuestas de la API

### Verificar Configuraci√≥n

1. **Variables de entorno**: Aseg√∫rate de que `.env` tenga `INSTANTLY_API_KEY`
2. **URL de la API**: Verifica `INSTANTLY_API_BASE_URL` en `.env`
3. **Permisos**: Confirma que tu API key tenga acceso a campa√±as

## üìù Logs y Monitoreo

### Sistema de Logging

- **Logs estructurados**: Formato JSON para an√°lisis
- **Niveles de log**: Info, Warning, Error
- **Contexto de operaciones**: ID de usuario, campa√±a, etc.
- **M√©tricas de rendimiento**: Tiempo de ejecuci√≥n, uso de memoria

### Monitoreo en Tiempo Real

- **Health checks**: Endpoints de estado de salud
- **M√©tricas de sincronizaci√≥n**: Conteo y estado de campa√±as
- **Estado de servicios**: Firebase y Instantly API
- **Alertas autom√°ticas**: Notificaciones de errores cr√≠ticos

## üîí Seguridad

### Autenticaci√≥n y Autorizaci√≥n

- **API Key de Instantly**: Autenticaci√≥n segura con la API externa
- **Firebase Auth**: Para funciones callable (requieren usuario autenticado)
- **Firestore Rules**: Solo lectura p√∫blica, escritura solo a trav√©s de Cloud Functions

### Protecci√≥n de Datos

- **Variables de Entorno**: Credenciales sensibles protegidas
- **Rate Limiting**: Prevenci√≥n de abuso y ataques
- **Validaci√≥n de Entrada**: Sanitizaci√≥n de todos los par√°metros
- **CORS Configurable**: Control de or√≠genes permitidos

## üö® Manejo de Errores

### Estrategias de Recuperaci√≥n

- **Reintentos autom√°ticos**: Hasta 3-5 intentos con backoff exponencial
- **Rate limiting inteligente**: Respeta l√≠mites de la API externa
- **Fallbacks robustos**: M√∫ltiples estrategias para operaciones cr√≠ticas
- **Logging detallado**: Informaci√≥n completa para debugging

### Tipos de Errores Manejados

- **Errores de red**: Timeouts, conexiones perdidas
- **Errores de API**: Rate limits, autenticaci√≥n fallida
- **Errores de base de datos**: Firestore no disponible
- **Errores de validaci√≥n**: Par√°metros inv√°lidos

## üìà Monitoreo y M√©tricas

### M√©tricas Disponibles

- **Campa√±as sincronizadas**: Conteo total y por estado
- **Tiempo de sincronizaci√≥n**: Duraci√≥n de operaciones
- **Tasa de √©xito**: Porcentaje de operaciones exitosas
- **Uso de recursos**: Memoria, CPU, tiempo de ejecuci√≥n

### Herramientas de Monitoreo

- **Firebase Console**: Monitoreo de funciones y logs
- **Cloud Logging**: Logs estructurados y m√©tricas
- **Cloud Monitoring**: M√©tricas de rendimiento y errores
- **Alertas autom√°ticas**: Notificaciones de problemas cr√≠ticos

## üîß Configuraci√≥n Avanzada

### Funciones Programadas

```javascript
// Configuraci√≥n de cron schedules
DAILY_SYNC_SCHEDULE = "0 2 * * *"; // 2:00 AM diario
WEEKLY_CLEANUP_SCHEDULE = "0 3 * * 0"; // 3:00 AM domingos
METRICS_SYNC_SCHEDULE = "0 */6 * * *"; // Cada 6 horas
WEEKLY_BACKUP_SCHEDULE = "0 4 * * 0"; // 4:00 AM domingos
```

### Rate Limiting

```javascript
// Configuraci√≥n por tipo de operaci√≥n
INSTANTLY_LIMITER: 60 requests/minuto
BULK_SYNC_LIMITER: 30 requests/minuto
METRICS_LIMITER: 100 requests/minuto
```

### Performance

```javascript
// Configuraci√≥n de funciones
MAX_INSTANCES: 10
TIMEOUT_SECONDS: 540 (9 minutos)
MEMORY_MB: 256
```

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

### Gu√≠as de Contribuci√≥n

- **C√≥digo**: Seguir est√°ndares de ESLint
- **Tests**: Mantener cobertura >80%
- **Documentaci√≥n**: Actualizar README y API docs
- **Commits**: Usar convenciones de Conventional Commits

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT. Ver el archivo `LICENSE` para m√°s detalles.

## üÜò Soporte

### Recursos Disponibles

- **Documentaci√≥n de API**: `API_DOCUMENTATION.md`
- **Issues de GitHub**: Para reportar bugs y solicitar features
- **Documentaci√≥n de Instantly**: API v2 reference
- **Firebase Docs**: Cloud Functions y Firestore

### Canales de Soporte

- **GitHub Issues**: Para problemas t√©cnicos
- **Discussions**: Para preguntas generales
- **Wiki**: Gu√≠as y tutoriales
- **Email**: Para consultas privadas

## üîÑ Changelog

### v2.0.0 (Actual)

- ‚ú® **Nuevas Cloud Functions**: HTTP, Callable y Programadas
- üöÄ **Rate Limiting Avanzado**: Sistema inteligente con backoff exponencial
- üîê **Gesti√≥n de Tokens**: Renovaci√≥n autom√°tica y almacenamiento seguro
- üìä **M√©tricas en Tiempo Real**: Endpoints para estad√≠sticas y monitoreo
- üïê **Funciones Programadas**: Sincronizaci√≥n autom√°tica diaria y limpieza semanal
- üìù **Logging Estructurado**: Sistema robusto de logs y m√©tricas
- üîß **Configuraci√≥n Flexible**: Variables de entorno para personalizaci√≥n
- üìö **Documentaci√≥n Completa**: API docs y gu√≠as de uso

### v1.0.0

- Integraci√≥n inicial con Instantly API v2
- Sincronizaci√≥n b√°sica de campa√±as
- Almacenamiento en Firestore
- Cloud Functions HTTP b√°sicas
- Sistema de logging b√°sico
- Tests automatizados

## üéØ Roadmap

### Pr√≥ximas Versiones

- **v2.1.0**: Webhooks para actualizaciones en tiempo real
- **v2.2.0**: Dashboard de monitoreo web
- **v2.3.0**: Integraci√≥n con otras plataformas de email
- **v3.0.0**: Migraci√≥n a TypeScript y mejoras de performance

---

**Desarrollado con ‚ù§Ô∏è para la integraci√≥n de Instantly API v2**

_Para m√°s informaci√≥n, consulta la [Documentaci√≥n de la API](API_DOCUMENTATION.md)_
